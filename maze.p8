pico-8 cartridge // http://www.pico-8.com
version 42
__lua__


function _init()
	vang, vpow = 0.5, 0
	px, py = find_first_sprite(6)
	mset(px/8, py/8, 24)
	px += 4
	py += 4
	pw, ph = 4, 4
end

function find_first_sprite(sprite_id)
 local map_width = 128
 local map_height = 64

 -- recorrer el mapa entero
 for ty = 0, map_height - 1 do
     for tx = 0, map_width - 1 do
         if mget(tx, ty) == sprite_id then
             return tx * 8, ty * 8
         end
     end
 end

 return nil -- no se encontrれは el sprite
end

function userinput()
	if (btn(0)) then
		vang += 0.03
	end
	if btn(1) then
		vang -= 0.03
	end
	if btn(2) then
		vpow += 0.1
	end
	if btn(3) then
	 vpow -= 0.1
	end
	vang = vang%1
	vpow = max(min(vpow, 1), 0)
end

function rects_overlap(x1, y1, w1, h1, x2, y2, w2, h2)
 return x1 < x2 + w2 and -- el lado izquierdo del rectれくngulo 1 estれく a la izquierda del lado derecho del rectれくngulo 2
  x1 + w1 > x2 and -- el lado derecho del rectれくngulo 1 estれく a la derecha del lado izquierdo del rectれくngulo 2
  y1 < y2 + h2 and -- el lado superior del rectれくngulo 1 estれく por encima del lado inferior del rectれくngulo 2
  y1 + h1 > y2     -- el lado inferior del rectれくngulo 1 estれく por debajo del lado superior del rectれくngulo 2
end


function overlap_map() 
 local pl = px - pw / 2
 local pu = py - ph / 2

 -- coordenadas del rectれくngulo del objeto en el mapa
 local left = flr(pl / 8)
 local right = flr((pl + pw - 1) / 8)
 local top = flr(pu / 8)
 local bottom = flr((pu + ph - 1) / 8)

 -- recopilar todos los tiles que intersectan con el objeto
 local tiles = {}
 for tx = left, right do
  for ty = top, bottom do
   if tx >= 0 and ty >= 0 and tx < 128 and ty < 128 then -- ajustar segれむn el tamaれねo del mapa
    add(tiles, mget(tx, ty))
   end
  end
 end

 -- verificar si alguno de los tiles tiene el flag 7 activo
 for tile in all(tiles) do
	 if fget(tile, 7) then
	  return true
	 end
 end
 return false 
end

function _update()
	userinput()
	
	if (vpower == 0) return
	
	local vx, vy = 
		vpow*cos(vang), 
		vpow*sin(vang)
	
 -- intentar mover en el eje x primero
 if vx ~= 0 then
  px = px + vx
  if overlap_map() then
   -- deshacer el movimiento en x si colisiona
   px = px - vx
  end
 end

 -- intentar mover en el eje y despuれたs
 if vy ~= 0 then
  py = py + vy
  if overlap_map() then
   -- deshacer el movimiento en y si colisiona
   py = py - vy
  end
 end
	vx, vy = 0, 0
	
end

function draw_user()
	spr(6, px-4, py-4)
end

function _draw()
	cls()
	map(0, 0)
	draw_user()
	local vx, vy = 
		cos(vang), 
		sin(vang)
	line(px, py, px+vx*10, 
		py+vy*10, 11)
end


__gfx__
00000000008888000000000000000000000000003333333300000000444444444444444444444444444444444ffffff400000000000000000000000000000000
00000000087788800000000000cc00000000000033333333000000004ffffffffffffffffffffff4ffffffff4ffffff400000000000000000000000000000000
00700700878888880099999000cc000000cc00003333333300cb8c004ffffffffffffffffffffff4ffffffff4ffffff400000000000000000000000000000000
000770008888888809000090099ff990099ff9903333333300bee8004ffffffffffffffffffffff4ffffffff4ffffff400000000000000000000000000000000
000770008888888809999990099ff990099ff99033333333004eed004ffffffffffffffffffffff4ffffffff4ffffff400000000000000000000000000000000
0070070088888888000000000000cc000000cc003333333300c4dc004ffffffffffffffffffffff4ffffffff4ffffff400000000000000000000000000000000
0000000008888880000000000000cc000000000033333333000000004ffffffffffffffffffffff4ffffffff4ffffff400000000000000000000000000000000
000000000088880000000000000000000000000033333333000000004ffffffffffffffffffffff4444444444ffffff400000000000000000000000000000000
000000000000000000000000000000000000000000000000000000004ffffffffffffffffffffff4000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000004ffffffffffffffffffffff4000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000004ffffffffffffffffffffff4000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000004ffffffffffffffffffffff4000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000004ffffffffffffffffffffff4000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000004ffffffffffffffffffffff4000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000004ffffffffffffffffffffff4000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000004ffffffffffffffffffffff4000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000004ffffffffffffffffffffff4000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000004ffffffffffffffffffffff4000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000004ffffffffffffffffffffff4000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000004ffffffffffffffffffffff4000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000004ffffffffffffffffffffff4000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000004ffffffffffffffffffffff4000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000004ffffffffffffffffffffff4000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000444444444444444444444444000000000000000000000000000000000000000000000000
__gff__
0000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0505050505050505050505050505050500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0518050518180518180518051818180500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0518181818050505180518181805180500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0505050518181818180518050505180500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0518180518051805180518051818180500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0505181818051805050518050505180500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0518050505051818181818051805180500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0518051805180505050518051818180500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0518181805180518050518051805180500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0518051805181818051818181805050500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0505051805050518050518051805180500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0505181818181818180518051818180500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0518180518180518180518050505180500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0505180505050518051818181818180500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0518181818051818181805181818060500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0505050505050505050505050505050500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
